#include "slope.h"

#define BIN_PI 32768
#define BIN_TAU_MINUS_ONE 65535
#define BIN_PI_OVER_TWO 16384

unsigned atan_table[2049] = {
    0, 5, 10, 15, 20, 25, 31, 36, 41, 46, 
    56, 61, 66, 71, 76, 81, 87, 92, 97, 102, 
    112, 117, 122, 127, 132, 138, 143, 148, 153, 158, 
    168, 173, 178, 183, 188, 194, 199, 204, 209, 214, 
    224, 229, 234, 239, 244, 250, 255, 260, 265, 270, 
    280, 285, 290, 295, 300, 305, 311, 316, 321, 326, 
    336, 341, 346, 351, 356, 361, 367, 372, 377, 382, 
    392, 397, 402, 407, 412, 417, 422, 428, 433, 438, 
    448, 453, 458, 463, 468, 473, 478, 483, 489, 494, 
    504, 509, 514, 519, 524, 529, 534, 539, 544, 550, 
    560, 565, 570, 575, 580, 585, 590, 595, 600, 605, 
    616, 621, 626, 631, 636, 641, 646, 651, 656, 661, 
    671, 676, 681, 687, 692, 697, 702, 707, 712, 717, 
    727, 732, 737, 742, 747, 752, 758, 763, 768, 773, 
    783, 788, 793, 798, 803, 808, 813, 818, 823, 828, 
    839, 844, 849, 854, 859, 864, 869, 874, 879, 884, 
    894, 899, 904, 909, 914, 919, 924, 930, 935, 940, 
    950, 955, 960, 965, 970, 975, 980, 985, 990, 995, 
    1005, 1010, 1015, 1020, 1025, 1031, 1036, 1041, 1046, 1051, 
    1061, 1066, 1071, 1076, 1081, 1086, 1091, 1096, 1101, 1106, 
    1116, 1121, 1126, 1131, 1136, 1141, 1146, 1151, 1156, 1161, 
    1172, 1177, 1182, 1187, 1192, 1197, 1202, 1207, 1212, 1217, 
    1227, 1232, 1237, 1242, 1247, 1252, 1257, 1262, 1267, 1272, 
    1282, 1287, 1292, 1297, 1302, 1307, 1312, 1317, 1322, 1327, 
    1337, 1342, 1347, 1352, 1357, 1362, 1367, 1372, 1377, 1382, 
    1392, 1397, 1402, 1407, 1412, 1417, 1422, 1427, 1432, 1437, 
    1447, 1452, 1457, 1462, 1467, 1472, 1477, 1482, 1487, 1492, 
    1502, 1507, 1512, 1517, 1522, 1527, 1532, 1537, 1542, 1547, 
    1557, 1562, 1567, 1572, 1577, 1582, 1587, 1592, 1597, 1602, 
    1612, 1617, 1622, 1627, 1632, 1637, 1642, 1646, 1651, 1656, 
    1666, 1671, 1676, 1681, 1686, 1691, 1696, 1701, 1706, 1711, 
    1721, 1726, 1731, 1736, 1741, 1746, 1751, 1756, 1761, 1765, 
    1775, 1780, 1785, 1790, 1795, 1800, 1805, 1810, 1815, 1820, 
    1830, 1835, 1840, 1845, 1849, 1854, 1859, 1864, 1869, 1874, 
    1884, 1889, 1894, 1899, 1904, 1909, 1914, 1918, 1923, 1928, 
    1938, 1943, 1948, 1953, 1958, 1963, 1968, 1973, 1977, 1982, 
    1992, 1997, 2002, 2007, 2012, 2017, 2022, 2027, 2031, 2036, 
    2046, 2051, 2056, 2061, 2066, 2071, 2076, 2080, 2085, 2090, 
    2100, 2105, 2110, 2115, 2120, 2124, 2129, 2134, 2139, 2144, 
    2154, 2159, 2163, 2168, 2173, 2178, 2183, 2188, 2193, 2198, 
    2207, 2212, 2217, 2222, 2227, 2232, 2237, 2241, 2246, 2251, 
    2261, 2266, 2271, 2275, 2280, 2285, 2290, 2295, 2300, 2305, 
    2314, 2319, 2324, 2329, 2334, 2338, 2343, 2348, 2353, 2358, 
    2367, 2372, 2377, 2382, 2387, 2392, 2396, 2401, 2406, 2411, 
    2421, 2425, 2430, 2435, 2440, 2445, 2450, 2454, 2459, 2464, 
    2474, 2478, 2483, 2488, 2493, 2498, 2502, 2507, 2512, 2517, 
    2526, 2531, 2536, 2541, 2546, 2550, 2555, 2560, 2565, 2570, 
    2579, 2584, 2589, 2594, 2598, 2603, 2608, 2613, 2617, 2622, 
    2632, 2637, 2641, 2646, 2651, 2656, 2660, 2665, 2670, 2675, 
    2684, 2689, 2694, 2699, 2703, 2708, 2713, 2718, 2722, 2727, 
    2737, 2741, 2746, 2751, 2756, 2760, 2765, 2770, 2775, 2779, 
    2789, 2793, 2798, 2803, 2808, 2812, 2817, 2822, 2827, 2831, 
    2841, 2846, 2850, 2855, 2860, 2864, 2869, 2874, 2879, 2883, 
    2893, 2897, 2902, 2907, 2912, 2916, 2921, 2926, 2930, 2935, 
    2944, 2949, 2954, 2959, 2963, 2968, 2973, 2977, 2982, 2987, 
    2996, 3001, 3005, 3010, 3015, 3019, 3024, 3029, 3033, 3038, 
    3047, 3052, 3057, 3061, 3066, 3071, 3075, 3080, 3085, 3089, 
    3099, 3103, 3108, 3113, 3117, 3122, 3127, 3131, 3136, 3141, 
    3150, 3155, 3159, 3164, 3168, 3173, 3178, 3182, 3187, 3192, 
    3201, 3206, 3210, 3215, 3219, 3224, 3229, 3233, 3238, 3243, 
    3252, 3256, 3261, 3266, 3270, 3275, 3279, 3284, 3289, 3293, 
    3302, 3307, 3312, 3316, 3321, 3325, 3330, 3335, 3339, 3344, 
    3353, 3358, 3362, 3367, 3371, 3376, 3380, 3385, 3390, 3394, 
    3403, 3408, 3412, 3417, 3422, 3426, 3431, 3435, 3440, 3444, 
    3453, 3458, 3463, 3467, 3472, 3476, 3481, 3485, 3490, 3494, 
    3503, 3508, 3513, 3517, 3522, 3526, 3531, 3535, 3540, 3544, 
    3553, 3558, 3562, 3567, 3571, 3576, 3580, 3585, 3589, 3594, 
    3603, 3608, 3612, 3617, 3621, 3626, 3630, 3635, 3639, 3644, 
    3653, 3657, 3662, 3666, 3670, 3675, 3679, 3684, 3688, 3693, 
    3702, 3706, 3711, 3715, 3720, 3724, 3729, 3733, 3738, 3742, 
    3751, 3756, 3760, 3764, 3769, 3773, 3778, 3782, 3787, 3791, 
    3800, 3804, 3809, 3813, 3818, 3822, 3827, 3831, 3836, 3840, 
    3849, 3853, 3858, 3862, 3867, 3871, 3875, 3880, 3884, 3889, 
    3898, 3902, 3906, 3911, 3915, 3920, 3924, 3928, 3933, 3937, 
    3946, 3950, 3955, 3959, 3964, 3968, 3972, 3977, 3981, 3985, 
    3994, 3999, 4003, 4007, 4012, 4016, 4021, 4025, 4029, 4034, 
    4042, 4047, 4051, 4055, 4060, 4064, 4069, 4073, 4077, 4082, 
    4090, 4095, 4099, 4103, 4108, 4112, 4116, 4121, 4125, 4129, 
    4138, 4142, 4147, 4151, 4155, 4160, 4164, 4168, 4173, 4177, 
    4186, 4190, 4194, 4199, 4203, 4207, 4211, 4216, 4220, 4224, 
    4233, 4237, 4242, 4246, 4250, 4254, 4259, 4263, 4267, 4272, 
    4280, 4284, 4289, 4293, 4297, 4302, 4306, 4310, 4314, 4319, 
    4327, 4331, 4336, 4340, 4344, 4349, 4353, 4357, 4361, 4366, 
    4374, 4378, 4383, 4387, 4391, 4395, 4400, 4404, 4408, 4412, 
    4421, 4425, 4429, 4433, 4438, 4442, 4446, 4450, 4454, 4459, 
    4467, 4471, 4476, 4480, 4484, 4488, 4492, 4497, 4501, 4505, 
    4513, 4518, 4522, 4526, 4530, 4534, 4539, 4543, 4547, 4551, 
    4559, 4564, 4568, 4572, 4576, 4580, 4585, 4589, 4593, 4597, 
    4605, 4610, 4614, 4618, 4622, 4626, 4630, 4634, 4639, 4643, 
    4651, 4655, 4659, 4663, 4668, 4672, 4676, 4680, 4684, 4688, 
    4697, 4701, 4705, 4709, 4713, 4717, 4721, 4725, 4730, 4734, 
    4742, 4746, 4750, 4754, 4758, 4762, 4767, 4771, 4775, 4779, 
    4787, 4791, 4795, 4799, 4803, 4807, 4812, 4816, 4820, 4824, 
    4832, 4836, 4840, 4844, 4848, 4852, 4856, 4860, 4865, 4869, 
    4877, 4881, 4885, 4889, 4893, 4897, 4901, 4905, 4909, 4913, 
    4921, 4925, 4929, 4933, 4937, 4941, 4945, 4949, 4954, 4958, 
    4966, 4970, 4974, 4978, 4982, 4986, 4990, 4994, 4998, 5002, 
    5010, 5014, 5018, 5022, 5026, 5030, 5034, 5038, 5042, 5046, 
    5054, 5058, 5062, 5066, 5070, 5074, 5078, 5082, 5086, 5090, 
    5097, 5101, 5105, 5109, 5113, 5117, 5121, 5125, 5129, 5133, 
    5141, 5145, 5149, 5153, 5157, 5161, 5165, 5169, 5173, 5177, 
    5184, 5188, 5192, 5196, 5200, 5204, 5208, 5212, 5216, 5220, 
    5228, 5232, 5235, 5239, 5243, 5247, 5251, 5255, 5259, 5263, 
    5271, 5275, 5278, 5282, 5286, 5290, 5294, 5298, 5302, 5306, 
    5313, 5317, 5321, 5325, 5329, 5333, 5337, 5341, 5344, 5348, 
    5356, 5360, 5364, 5368, 5371, 5375, 5379, 5383, 5387, 5391, 
    5398, 5402, 5406, 5410, 5414, 5418, 5421, 5425, 5429, 5433, 
    5441, 5444, 5448, 5452, 5456, 5460, 5464, 5467, 5471, 5475, 
    5483, 5486, 5490, 5494, 5498, 5502, 5505, 5509, 5513, 5517, 
    5524, 5528, 5532, 5536, 5540, 5543, 5547, 5551, 5555, 5559, 
    5566, 5570, 5574, 5577, 5581, 5585, 5589, 5592, 5596, 5600, 
    5608, 5611, 5615, 5619, 5623, 5626, 5630, 5634, 5638, 5641, 
    5649, 5652, 5656, 5660, 5664, 5667, 5671, 5675, 5679, 5682, 
    5690, 5694, 5697, 5701, 5705, 5708, 5712, 5716, 5720, 5723, 
    5731, 5734, 5738, 5742, 5745, 5749, 5753, 5757, 5760, 5764, 
    5771, 5775, 5779, 5782, 5786, 5790, 5793, 5797, 5801, 5804, 
    5812, 5815, 5819, 5823, 5826, 5830, 5834, 5837, 5841, 5845, 
    5852, 5856, 5859, 5863, 5867, 5870, 5874, 5878, 5881, 5885, 
    5892, 5896, 5899, 5903, 5907, 5910, 5914, 5917, 5921, 5925, 
    5932, 5936, 5939, 5943, 5946, 5950, 5954, 5957, 5961, 5964, 
    5972, 5975, 5979, 5982, 5986, 5990, 5993, 5997, 6000, 6004, 
    6011, 6015, 6018, 6022, 6025, 6029, 6033, 6036, 6040, 6043, 
    6050, 6054, 6058, 6061, 6065, 6068, 6072, 6075, 6079, 6082, 
    6089, 6093, 6097, 6100, 6104, 6107, 6111, 6114, 6118, 6121, 
    6128, 6132, 6135, 6139, 6142, 6146, 6150, 6153, 6157, 6160, 
    6167, 6171, 6174, 6178, 6181, 6185, 6188, 6192, 6195, 6199, 
    6206, 6209, 6213, 6216, 6220, 6223, 6227, 6230, 6234, 6237, 
    6244, 6247, 6251, 6254, 6258, 6261, 6265, 6268, 6272, 6275, 
    6282, 6286, 6289, 6292, 6296, 6299, 6303, 6306, 6310, 6313, 
    6320, 6323, 6327, 6330, 6334, 6337, 6341, 6344, 6348, 6351, 
    6358, 6361, 6365, 6368, 6371, 6375, 6378, 6382, 6385, 6389, 
    6395, 6399, 6402, 6406, 6409, 6412, 6416, 6419, 6423, 6426, 
    6433, 6436, 6440, 6443, 6446, 6450, 6453, 6456, 6460, 6463, 
    6470, 6473, 6477, 6480, 6483, 6487, 6490, 6493, 6497, 6500, 
    6507, 6510, 6514, 6517, 6520, 6524, 6527, 6530, 6534, 6537, 
    6544, 6547, 6550, 6554, 6557, 6560, 6564, 6567, 6570, 6574, 
    6580, 6584, 6587, 6590, 6594, 6597, 6600, 6604, 6607, 6610, 
    6617, 6620, 6623, 6627, 6630, 6633, 6637, 6640, 6643, 6646, 
    6653, 6656, 6660, 6663, 6666, 6669, 6673, 6676, 6679, 6683, 
    6689, 6692, 6696, 6699, 6702, 6705, 6709, 6712, 6715, 6718, 
    6725, 6728, 6731, 6735, 6738, 6741, 6744, 6748, 6751, 6754, 
    6761, 6764, 6767, 6770, 6774, 6777, 6780, 6783, 6787, 6790, 
    6796, 6799, 6803, 6806, 6809, 6812, 6815, 6819, 6822, 6825, 
    6832, 6835, 6838, 6841, 6844, 6848, 6851, 6854, 6857, 6860, 
    6867, 6870, 6873, 6876, 6879, 6883, 6886, 6889, 6892, 6895, 
    6902, 6905, 6908, 6911, 6914, 6917, 6921, 6924, 6927, 6930, 
    6936, 6940, 6943, 6946, 6949, 6952, 6955, 6958, 6962, 6965, 
    6971, 6974, 6977, 6980, 6984, 6987, 6990, 6993, 6996, 6999, 
    7005, 7009, 7012, 7015, 7018, 7021, 7024, 7027, 7030, 7033, 
    7040, 7043, 7046, 7049, 7052, 7055, 7058, 7061, 7064, 7068, 
    7074, 7077, 7080, 7083, 7086, 7089, 7092, 7095, 7098, 7101, 
    7108, 7111, 7114, 7117, 7120, 7123, 7126, 7129, 7132, 7135, 
    7141, 7144, 7147, 7150, 7154, 7157, 7160, 7163, 7166, 7169, 
    7175, 7178, 7181, 7184, 7187, 7190, 7193, 7196, 7199, 7202, 
    7208, 7211, 7214, 7217, 7220, 7223, 7226, 7229, 7232, 7235, 
    7241, 7244, 7247, 7250, 7253, 7256, 7259, 7262, 7265, 7268, 
    7274, 7277, 7280, 7283, 7286, 7289, 7292, 7295, 7298, 7301, 
    7307, 7310, 7313, 7316, 7319, 7322, 7325, 7328, 7331, 7334, 
    7340, 7343, 7346, 7349, 7352, 7355, 7358, 7361, 7363, 7366, 
    7372, 7375, 7378, 7381, 7384, 7387, 7390, 7393, 7396, 7399, 
    7405, 7408, 7411, 7413, 7416, 7419, 7422, 7425, 7428, 7431, 
    7437, 7440, 7443, 7446, 7448, 7451, 7454, 7457, 7460, 7463, 
    7469, 7472, 7475, 7477, 7480, 7483, 7486, 7489, 7492, 7495, 
    7501, 7503, 7506, 7509, 7512, 7515, 7518, 7521, 7524, 7526, 
    7532, 7535, 7538, 7541, 7544, 7547, 7549, 7552, 7555, 7558, 
    7564, 7566, 7569, 7572, 7575, 7578, 7581, 7584, 7586, 7589, 
    7595, 7598, 7601, 7603, 7606, 7609, 7612, 7615, 7618, 7620, 
    7626, 7629, 7632, 7635, 7637, 7640, 7643, 7646, 7649, 7651, 
    7657, 7660, 7663, 7665, 7668, 7671, 7674, 7677, 7679, 7682, 
    7688, 7691, 7693, 7696, 7699, 7702, 7705, 7707, 7710, 7713, 
    7718, 7721, 7724, 7727, 7730, 7732, 7735, 7738, 7741, 7743, 
    7749, 7752, 7754, 7757, 7760, 7763, 7765, 7768, 7771, 7774, 
    7779, 7782, 7785, 7787, 7790, 7793, 7796, 7798, 7801, 7804, 
    7809, 7812, 7815, 7818, 7820, 7823, 7826, 7828, 7831, 7834, 
    7839, 7842, 7845, 7848, 7850, 7853, 7856, 7858, 7861, 7864, 
    7869, 7872, 7875, 7877, 7880, 7883, 7885, 7888, 7891, 7893, 
    7899, 7902, 7904, 7907, 7910, 7912, 7915, 7918, 7920, 7923, 
    7928, 7931, 7934, 7936, 7939, 7942, 7944, 7947, 7950, 7952, 
    7958, 7960, 7963, 7966, 7968, 7971, 7974, 7976, 7979, 7982, 
    7987, 7990, 7992, 7995, 7997, 8000, 8003, 8005, 8008, 8011, 
    8016, 8019, 8021, 8024, 8026, 8029, 8032, 8034, 8037, 8040, 
    8045, 8047, 8050, 8053, 8055, 8058, 8060, 8063, 8066, 8068, 
    8074, 8076, 8079, 8081, 8084, 8087, 8089, 8092, 8094, 8097, 
    8102, 8105, 8107, 8110, 8112, 8115, 8118, 8120, 8123, 8125, 
    8131, 8133, 8136, 8138, 8141, 8143, 8146, 8149, 8151, 8154, 
    8159, 8161, 8164, 8166, 8169, 8172, 8174, 8177, 8179, 8182, 
    8187, 8189, 8192 };

angle_t slope_to_angle(int x, int y)
{
    unsigned absX = abs(x);
    unsigned absY = abs(y);

    unsigned angle;
    if(absX > absY)
    {
        if(absX < 512) angle = 8192;
        else angle = atan_table[(absY << 3) / (absX >> 8)];
    }
    else
    {
        if(absY < 512) angle = BIN_PI_OVER_TWO - 8192;
        else angle = BIN_PI_OVER_TWO - atan_table[(absX << 3) / (absY >> 8)];
    }

    if(y >= 0)
    {
        if(x >= 0) {
            return angle;
        } else {
            return BIN_PI - angle;
        }
    } else {
        if(x >= 0) {
            return BIN_TAU_MINUS_ONE - angle + 1;
        } else {
            return angle + BIN_PI;
        }
    }

}